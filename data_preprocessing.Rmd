---
title: "Data Preprocessing"
author: "Louise Brix Pilegaard Hansen and Rikke Uldbæk"
date: "2023-04-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("leaflet")
#install.packages("googlesheets4")
```

```{r}
library(sp)
library(rgdal)
library(sf)
library(leaflet)
library(readxl)
library(googlesheets4)
```

# Load Google Sheets datapoints

```{r}
googlesheets4::gs4_deauth()
googlesheets4::gs4_auth()

sheets_data <- read_sheet("https://docs.google.com/spreadsheets/d/1Qdjz-TU4ispjOAkpdMw9b8wGRgpLUHeg3CjE4lzD-iQ/edit#gid=0", range = "AarhusData")

# need to divide the coordinates
sheets_data_sf <- st_as_sf(sheets_data)
```


```{r}
data <- read_excel("./data/cult_activities_aarhus.xls")
data$latitude <- as.numeric(data$Latitude)
data$longitude <- as.numeric(data$Longitude)
```


WORKFLOW: 
- Read in json files from folder
- read them in as a Spatial Object
- add them all to same sf dataframe
- transform CRS to '4326' (= same as leaflet)
- extract coordinates
- plot in leaflet


## Read in GeoJSON data from OpenData

```{r}
playgrounds <- st_read("data/geojson_files/legepladser.json")
```

```{r}
st_crs(playgrounds)
```

The EPSG of the playgrounds object is 25832. The CRS of leaflet is 4326, so we need to transform the coordinates

```{r}
playgrounds <- playgrounds %>% 
  st_transform(crs = 4326)
```

Now leaflet and "playgrounds" have the same CRS and can be plotted:
```{r}
st_crs(playgrounds)
```

```{r}
coords_playground <- st_coordinates(playgrounds)

c <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=coords_playground[, 1], lat=coords_playground[, 2], popup = playgrounds$lokation)
c  # Print the map
```


## Load GeoJSon files
```{r}
create_sf <- function(df, name, geo, act_type, description, indoor_outdoor, group){

#df <- st_read(paste0('data/geojson_files/', geo_json))

name <- df[[name]]
geometry <- df[[geo]]
type <- rep(act_type, length(geometry))
all <- 'Show all'
description <- rep(description, length(geometry))
group <- rep(group, length(geometry))
indoor_outdoor<- rep(indoor_outdoor, length(geometry))

df_new <- data.frame(name, geometry, type, all, description, group, indoor_outdoor)

df_sf <- st_as_sf(df_new)

df_sf <- df_sf %>% 
 st_transform(crs = 4326)

return(df_sf)
}
```

# load as dataframes to see their column names
```{r}
playgrounds_json <- st_read('data/geojson_files/legepladser.json')

free_fitness_json <- st_read('data/geojson_files/fitness_i_det_fri.json')

shelters_json <- st_read('data/geojson_files/shelter.json')

climbing_json <- st_read('data/geojson_files/træklatring.json')
```

```{r}
head(playgrounds_json)
head(free_fitness_json)
head(shelters_json)
head(climbing_json)
```

Based on the column names, create new dataframes
```{r}
playgrounds <- create_sf(playgrounds_json, 'lokation', 'geometry', 'Playground', 'Outdoor playground', 'Outdoor', 'Children')

outdoor_fitness <- create_sf(free_fitness_json, 'navn', 'geometry', 'Exercise','Outdoor fitness facilities', 'Outdoor', 'Adults')

shelters <- create_sf(shelters_json, 'navn', 'geometry', 'Shelter', 'Outdoor shelter', 'Outdoor', 'Both children and adults')

tree_climbing <- create_sf(climbing_json, 'navn', 'geometry', 'Tree climbing', 'Climbing', 'Outdoor', 'Both children and adults')
```

Points, multipoints and polygons can't all be plotted together, so we need to make seperate dataframes
```{r}
df_points <- rbind(playgrounds, shelters)

df_multipoints <- outdoor_fitness
  
df_polygons <- tree_climbing
```

# extract coordinates from points and multipoints and bind them together to one dataframe 
```{r}
points_coords <- st_coordinates(df_points)

multi_coords <- st_coordinates(df_multipoints)

df_points <- cbind(df_points, points_coords)

df_multipoints <- cbind(df_multipoints, multi_coords)

df_multipoints <- subset(df_multipoints, select = -c(L1))

df_all <- rbind(df_points, df_multipoints)
```



## map that adds all points and polygons
```{r}
c <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=df_all$X, lat=df_all$Y, popup = df_all$name, clusterOptions = markerClusterOptions()) %>%
  addPolygons(data = df_polygons, label = df_polygons$name)
c  # Print the map
```


noter:

- add markerClustering!
- awesomeMarkers? ændre på marker type
- indlæse flere geojson files
- indlæse excel ark med data punkter


