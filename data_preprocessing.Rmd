---
title: "Data Preprocessing"
author: "Louise Brix Pilegaard Hansen and Rikke Uldbæk"
date: "2023-04-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("leaflet")
#install.packages("googlesheets4")
```

```{r}
options(digits = 15)
```

```{r}
library(sp)
library(rgdal)
library(sf)
library(leaflet)
library(readxl)
library(googlesheets4)
library(tidyverse)
```



## Read in GeoJSON data from OpenData

```{r}
playgrounds <- st_read("data/geojson_files/legepladser.json")
```

```{r}
st_crs(playgrounds)
```

The EPSG of the playgrounds object is 25832. The CRS of leaflet is 4326, so we need to transform the coordinates

```{r}
playgrounds <- playgrounds %>% 
  st_transform(crs = 4326)
```

Now leaflet and "playgrounds" have the same CRS and can be plotted:
```{r}
st_crs(playgrounds)
```

```{r}
coords_playground <- st_coordinates(playgrounds)

c <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=coords_playground[, 1], lat=coords_playground[, 2], popup = playgrounds$lokation)
c  # Print the map
```


## Load GeoJSon files
```{r}
create_sf <- function(df, name, geo, act_type, description, indoor_outdoor, group){

#df <- st_read(paste0('data/geojson_files/', geo_json))

name <- df[[name]]
geometry <- df[[geo]]
type <- rep(act_type, length(geometry))
all_type <- 'Show all'
description <- rep(description, length(geometry))
group <- rep(group, length(geometry))
all_group<- 'Show all'
indoor_outdoor<- rep(indoor_outdoor, length(geometry))
all_in_out <- 'Show all'

df_new <- data.frame(name, geometry, type, all_type, description, group, all_group, indoor_outdoor, all_in_out)

df_sf <- st_as_sf(df_new)

df_sf <- df_sf %>% 
 st_transform(crs = 4326)

return(df_sf)
}
```

# load as dataframes to see their column names
```{r}
playgrounds_json <- st_read('data/geojson_files/legepladser.json')

free_fitness_json <- st_read('data/geojson_files/fitness_i_det_fri.json')

shelters_json <- st_read('data/geojson_files/shelter.json')

climbing_json <- st_read('data/geojson_files/træklatring.json')

# de her to skal der måske filtreres lidt i? er pt. ikke med i datasettet, da mange af punkterne måske lægger udenfor vores grænse
forests_json <- st_read('data/geojson_files/store_skove.json')

firepits_json <- st_read('data/geojson_files/bålpladser.json')
```

```{r}
head(playgrounds_json)
head(free_fitness_json)
head(shelters_json)
head(climbing_json)
```

Based on the column names, create new dataframes

```{r}
playgrounds <- create_sf(playgrounds_json, 'lokation', 'geometry', 'Playground', 'Outdoor playground', 'Outdoor', 'Children')

outdoor_fitness <- create_sf(free_fitness_json, 'navn', 'geometry', 'Exercise','Outdoor fitness facilities', 'Outdoor', 'Adults')

shelters <- create_sf(shelters_json, 'navn', 'geometry', 'Shelter', 'Outdoor shelter', 'Outdoor', 'Both children and adults')

tree_climbing <- create_sf(climbing_json, 'navn', 'geometry', 'Tree climbing', 'Climbing', 'Outdoor', 'Both children and adults')
```

Points, multipoints and polygons can't all be plotted together, so we need to make seperate dataframes
```{r}
df_points <- rbind(playgrounds, shelters)

df_multipoints <- outdoor_fitness
  
df_polygons <- tree_climbing
```

# extract coordinates from points and multipoints and bind them together to one dataframe 
```{r}
points_coords <- st_coordinates(df_points)

multi_coords <- st_coordinates(df_multipoints)

df_points <- cbind(df_points, points_coords)

df_multipoints <- cbind(df_multipoints, multi_coords)

df_multipoints <- subset(df_multipoints, select = -c(L1))

df_all <- rbind(df_points, df_multipoints)

df_all <- df_all %>% 
  rename(longitude = X,
         latitude = Y)
```

```{r}
excel_data <- read_excel("./data/DiscoverAarhus.xlsx")

#excel_data <- excel_data[, c("name", "type", "type_all", "description", "group", "group_all", "indoor_outdoor", "in_out_all", "longitude", "latitude", "geometry")]

excel_data <- excel_data %>% 
  drop_na()

excel_sf <- st_as_sf(x = excel_data, coords=c("longitude", "latitude"), crs = 4326)

own_data_coords <- st_coordinates(excel_sf)

excel_sf <- cbind(excel_sf, own_data_coords)

df_all <- rbind(df_all, excel_sf)

df_all <- df_all %>% 
  rename(longitude = X,
         latitude = Y)
```

```{r}
write_csv(df_all, 'data/final_data.csv')
```


## map that adds all points and polygons
```{r}
c <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=df_all$longitude, lat=df_all$latitude, popup = paste0('<b>', df_all$name,'</b>','<br/>', '<i>',  df_all$description, '</i>'), clusterOptions = markerClusterOptions()) %>%
  addPolygons(data = df_polygons, label = df_polygons$name)
c  # Print the map
```

```{r}
test <- st_read('data/geojson_files/postdistrikter.json')

test <- test %>% 
  st_transform(crs = 4326)

zipcodes <- c(8000, 8200, 8210, 8220, 8230, 8240, 8250, 8260, 8270)

test_real <- test %>% 
  filter(postnummer %in% zipcodes)
```

```{r}
hej <- st_intersection(df_all, test_real)
```
```{r}
c <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=hej$longitude, lat=hej$latitude, popup = paste0('<b>', hej$name,'</b>','<br/>', '<i>',  hej$description, '</i>'), clusterOptions = markerClusterOptions()) %>%
  addPolygons(data = df_polygons, label = df_polygons$name)
c  # Print the map
```


noter:

- awesomeMarkers? ændre på marker type
- indlæse flere geojson files
  skal evt ikke bruges
- indlæse excel ark med data punkter
- hvordan fungerer det ift. polygoner og shiny app
- når excel ark skal importeres til shiny app, hvordan skal formatet så helst være?
